# Inference RTC - Real-Time Chunking æ¨ç†ç³»ç»Ÿ

åŸºäº [Real-Time Action Chunking](https://github.com/Physical-Intelligence/real-time-chunking-kinetix) æ€æƒ³çš„æœºæ¢°è‡‚çœŸæœºæ¨ç†ç³»ç»Ÿã€‚

## ğŸ“š æ–‡æ¡£

- **[å·²å®Œæˆå·¥ä½œ](docs/COMPLETED.md)** - å·²å®ç°çš„åŠŸèƒ½å’Œç»„ä»¶è¯¦æƒ…
- **[å¾…å®Œæˆå·¥ä½œ](docs/TODO.md)** - è¿ç§»åéœ€è¦å®Œæˆçš„ä»»åŠ¡æ¸…å•

## æ¶æ„æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Python æ¨ç†è¿›ç¨‹ (inference_main.py)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ CameraManager   â”‚â”€â”€â”€â”€â–ºâ”‚ PolicyRunner    â”‚â”€â”€â”€â”€â–ºâ”‚ KeyframeWriter      â”‚   â”‚
â”‚  â”‚ @30Hz (åå°çº¿ç¨‹) â”‚     â”‚ @10Hz           â”‚     â”‚ (å†™å…¥å…±äº«å†…å­˜)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚              â”‚
â”‚  â”‚ RobotStateReaderâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ (è¯»å–å…±äº«å†…å­˜)   â”‚                                         â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                           å…±äº«å†…å­˜ (æ— é”å•å‘é€šä¿¡)                â”‚
                           - version (uint64)                   â”‚
                           - t_write_mono (double)              â”‚
                           - q_key[H][dof] (å…³é”®å¸§è½¨è¿¹)          â”‚
                                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         C++ ä¼ºæœè¿›ç¨‹ (servo_main)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ShmReader       â”‚â”€â”€â”€â”€â–ºâ”‚ TrajectoryBufferâ”‚â”€â”€â”€â”€â–ºâ”‚ CubicInterpolator   â”‚   â”‚
â”‚  â”‚ (è¯»å–å…±äº«å†…å­˜)   â”‚     â”‚ (Phase B:        â”‚     â”‚ @500Hz é‡‡æ ·          â”‚   â”‚
â”‚  â”‚                 â”‚     â”‚  committed/edit) â”‚     â”‚                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚              â”‚
â”‚  â”‚ SafetyLimiter   â”‚â—„â”€â”€â”€â”€â”‚ EMAFilter       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”‚ (å®‰å…¨é™åˆ¶)       â”‚     â”‚ (alpha=0.3)     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ arx5::Arx5JointController::set_joint_cmd() + send_recv_once()       â”‚   â”‚
â”‚  â”‚ @500Hz                                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç›®å½•ç»“æ„

```
inference_rtc/
â”œâ”€â”€ README.md                   # æœ¬æ–‡ä»¶
â”œâ”€â”€ CMakeLists.txt              # C++ æ„å»ºé…ç½®
â”‚
â”œâ”€â”€ python/                     # Python æ¨ç†è¿›ç¨‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ inference_main.py       # ä¸»å…¥å£
â”‚   â”œâ”€â”€ policy_runner.py        # ç­–ç•¥æ¨ç† @10Hz
â”‚   â”œâ”€â”€ shm_writer.py           # å…±äº«å†…å­˜å†™å…¥
â”‚   â””â”€â”€ config.py               # é…ç½®
â”‚
â”œâ”€â”€ cpp/                        # C++ ä¼ºæœè¿›ç¨‹
â”‚   â”œâ”€â”€ servo_main.cpp          # ä¸»å…¥å£
â”‚   â”œâ”€â”€ shm_reader.hpp          # å…±äº«å†…å­˜è¯»å–
â”‚   â”œâ”€â”€ trajectory_buffer.hpp   # è½¨è¿¹ç¼“å†²åŒº (Phase B)
â”‚   â”œâ”€â”€ cubic_interpolator.hpp  # ä¸‰æ¬¡æ ·æ¡æ’å€¼
â”‚   â””â”€â”€ safety_limiter.hpp      # å®‰å…¨é™åˆ¶
â”‚
â””â”€â”€ shared/                     # å…±äº«å®šä¹‰
    â”œâ”€â”€ shm_protocol.py         # Python ä¾§åè®®å®šä¹‰
    â””â”€â”€ shm_protocol.hpp        # C++ ä¾§åè®®å®šä¹‰
```

## å…³é”®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `policy_rate` | 10 Hz | ç­–ç•¥æ¨ç†é¢‘ç‡ |
| `obs_rate` | 30 Hz | ç›¸æœºé‡‡é›†é¢‘ç‡ |
| `servo_rate` | 500 Hz | ä¼ºæœæ§åˆ¶é¢‘ç‡ |
| `H` (keyframes) | 8 | æ¯æ¬¡æ¨ç†è¾“å‡ºçš„å…³é”®å¸§æ•° |
| `dt_key` | 1/30 s | å…³é”®å¸§æ—¶é—´é—´éš” |
| `commit_time` | 100 ms | Phase B: å·²æ‰¿è¯ºçª—å£ |
| `blend_window` | 30 ms | Phase B: æ··åˆè¿‡æ¸¡çª—å£ |

## å®æ–½é˜¶æ®µ

### Phase A: ç«¯åˆ°ç«¯è·‘é€š
- [x] å…±äº«å†…å­˜é€šä¿¡
- [x] Python 10Hz æ¨ç†
- [x] C++ 500Hz ä¸‰æ¬¡æ ·æ¡æ’å€¼
- [x] åŸºæœ¬å®‰å…¨é™åˆ¶

### Phase B: RTC å¹³æ»‘
- [ ] Committed/Editable è½¨è¿¹é˜Ÿåˆ—
- [ ] è¾¹ç•Œæ··åˆ (C1 stitching)
- [ ] Timeout fallback

### Phase C: æ€§èƒ½ä¼˜åŒ–
- [ ] fp16 æ¨ç†
- [ ] å¼‚æ­¥ SDK é€šä¿¡
- [ ] pin_memory

## ä½¿ç”¨æ–¹æ³•

```bash
# 1. æ„å»º C++ ä¼ºæœç¨‹åº
cd inference_rtc
mkdir build && cd build
cmake ..
make -j$(nproc)

# 2. å¯åŠ¨ C++ ä¼ºæœè¿›ç¨‹
./servo_main --model X5 --interface can0

# 3. å¯åŠ¨ Python æ¨ç†è¿›ç¨‹ (å¦ä¸€ä¸ªç»ˆç«¯)
python -m inference_rtc.python.inference_main -c checkpoint.pt

# æ¨¡æ‹Ÿæ¨¡å¼ (ä¸è¿æ¥æœºå™¨äºº)
python -m inference_rtc.python.inference_main -c checkpoint.pt --dry-run
```

## å…±äº«å†…å­˜åè®®

Python â†’ C++ å•å‘æ— é”é€šä¿¡:

```
Header (32 bytes):
  [0:8]   uint64  version      - é€’å¢ç‰ˆæœ¬å·
  [8:16]  double  t_write_mono - å†™å…¥æ—¶é—´ (CLOCK_MONOTONIC)
  [16:20] int32   dof          - è‡ªç”±åº¦ (7 = 6 å…³èŠ‚ + 1 å¤¹çˆª)
  [20:24] int32   H            - å…³é”®å¸§æ•°é‡ (8)
  [24:32] double  dt_key       - å…³é”®å¸§æ—¶é—´é—´éš” (1/30)

Payload (H * dof * 8 bytes = 448 bytes):
  double  q_key[H][dof]        - å…³é”®å¸§å…³èŠ‚ä½ç½®
```

åŒæ­¥æ–¹å¼:
- Python: å†™ payload â†’ version++
- C++: è¯» version1 â†’ payload â†’ version2ï¼Œversion1 == version2 æ‰é‡‡ç”¨
